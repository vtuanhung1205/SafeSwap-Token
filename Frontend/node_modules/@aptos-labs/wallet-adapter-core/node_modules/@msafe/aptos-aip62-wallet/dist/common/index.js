"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _tssdk = require('@aptos-labs/ts-sdk');var _walletstandard = require('@aptos-labs/wallet-standard');var c=class{constructor(){this._listeners={}}on(e,n,t=0){this._listeners[e]||(this._listeners[e]=[]),n._priority=t,this._listeners[e].indexOf(n)===-1&&(this._listeners[e].push(n),this._listeners[e].length>1&&this._listeners[e].sort(this.listenerSorter))}listenerSorter(e,n){return e._priority-n._priority}off(e,n){if(this._listeners[e]===void 0)return;if(n===void 0){delete this._listeners[e];return}let t=this._listeners[e].indexOf(n);-1<t&&this._listeners[e].splice(t,1)}trigger(e,n={}){if(typeof e=="string"&&(e={type:e,data:typeof n=="object"&&n!==null?n:{}}),typeof this._listeners[e.type]<"u")for(let t=this._listeners[e.type].length-1;t>=0;t--)this._listeners[e.type][t](e)}destroy(){this._listeners={}}};var a=class extends c{constructor(e=Math.random()*100|0){super(),this.id=`BELLHOP:${e}`,this.connected=!1,this.isChild=!0,this.connecting=!1,this.debug=!1,this.origin="*",this.supported=!1,this._sendLater=[],this.iframe=null,this.receive=this.receive.bind(this)}receive(e){if(this.target===e.source){if(this.logDebugMessage(!0,e),e.data!=="connected"){let n=e.data;if(typeof n=="string")try{n=JSON.parse(n)}catch(t){console.warn("Bellhop error: ",t)}this.connected&&typeof n=="object"&&n.type&&this.trigger(n);return}this.onConnectionReceived(e.data)}}onConnectionReceived(e){if(this.connecting=!1,this.connected=!0,!this.isChild){if(!this.target)return;this.target.postMessage(e,this.origin)}for(let n=0;n<this._sendLater.length;n++){let{type:t,data:i}=this._sendLater[n];this.send(t,i)}this._sendLater.length=0,this.trigger("connected")}connect(e,n="*"){this.connecting||(this.disconnect(),this.connecting=!0,e instanceof HTMLIFrameElement&&(this.iframe=e),this.isChild=e===void 0,this.supported=!0,this.isChild&&(this.supported=window!=e),this.origin=n,window.addEventListener("message",this.receive),this.isChild&&(window===this.target?this.trigger("failed"):_optionalChain([this, 'access', _ => _.target, 'optionalAccess', _2 => _2.postMessage, 'call', _3 => _3("connected",this.origin)])))}disconnect(){this.connected=!1,this.connecting=!1,this.origin="",this.iframe=null,this.isChild=!0,this._sendLater.length=0,window.removeEventListener("message",this.receive)}send(e,n={}){if(typeof e!="string")throw"The event type must be a string";let t={type:e,data:n};this.logDebugMessage(!1,t),this.connecting?this._sendLater.push(t):_optionalChain([this, 'access', _4 => _4.target, 'optionalAccess', _5 => _5.postMessage, 'call', _6 => _6(JSON.stringify(t,(i,s)=>typeof s=="bigint"?s.toString():s),this.origin)])}fetch(e,n,t={},i=!1){if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";let s=o=>{i&&this.off(o.type,s),n(o)};this.on(e,s),this.send(e,t)}respond(e,n={},t=!1){let i=this,s=async function(o){t&&i.off(o,s),typeof n=="function"?i.send(o.type,await n()):i.send(o.type,n)};this.on(e,s)}logDebugMessage(e=!1,n){this.debug&&typeof this.debug=="function"?console.log({isChild:this.isChild,received:e,message:n}):this.debug&&console.log(`Bellhop Instance (${this.isChild?"Child":"Parent"}) ${e?"Received":"Sent"}`,n)}destroy(){super.destroy(),this.disconnect(),this._sendLater.length=0}get target(){return this.isChild?window.parent:_optionalChain([this, 'access', _7 => _7.iframe, 'optionalAccess', _8 => _8.contentWindow])}};var A="MSafe";function ie(){return typeof window<"u"&&typeof document<"u"&&typeof parent<"u"&&typeof parent.window<"u"&&parent.window!==window}var f=class{constructor(e){this.chains=_walletstandard.APTOS_CHAINS;this.features=[];this.address=e.toString(),this.publicKey=new Uint8Array,this.chains=_walletstandard.APTOS_CHAINS,this.signingScheme=_tssdk.SigningScheme.MultiEd25519}},S= exports.MSafeWalletServer =class{constructor(e,n){this.iframe=e;this.api=n;this.bellhop=new a}connect(){this.bellhop.connect(this.iframe),this.bellhop.on("connect",async()=>{let e=await this.api.connect();console.log("\u{1F680} ~ MSafeWalletServer ~ on ~ connect:",e),this.bellhop.respond("connectResponse",{address:e})}),this.bellhop.on("signMessage",async e=>{let n=await this.api.signMessage(e);console.log("\u{1F680} ~ MSafeWalletServer ~ on ~ signMessage:",n),this.bellhop.respond("signMessageResponse",n)}),this.bellhop.on("signTransaction",async e=>{let n=await this.api.signTransaction(e);console.log("\u{1F680} ~ MSafeWalletServer ~ on ~ signTransaction:",n),this.bellhop.respond("signTransactionResponse",n)}),this.bellhop.on("submitTransaction",async e=>{let n=await this.api.submitTransaction(e);console.log("\u{1F680} ~ MSafeWalletServer ~ on ~ submitTransaction:",n),this.bellhop.respond("submitTransactionResponse",n)}),this.bellhop.on("signAndSubmitTransaction",async e=>{let n=await this.api.signAndSubmitTransaction(e);console.log("\u{1F680} ~ MSafeWalletServer ~ on ~ signAndSubmitTransaction:",n),this.bellhop.respond("signAndSubmitTransactionResponse",n)})}disconnect(){console.log("\u{1F680} ~ MSafeWalletServer ~ disconnect:"),this.bellhop.disconnect()}changeAccount(e){console.log("\u{1F680} ~ MSafeWalletServer ~ changeAccount:",e),this.bellhop.send("changeAccount",{address:e})}},m= exports.MSafeWallet =class{constructor(e){this.config=e;this.isAIP62Standard=!0;this.version="1.0.0";this.name=A;this.providerName=A;this.provider=null;this.icon="data:image/png;base64,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";this.chains=_walletstandard.APTOS_CHAINS;this.accounts=[];this.bellhop=new a;this.account=async()=>(console.log("\u{1F680} ~ MSafeWallet ~ AptosGetAccountMethod:"),this.getCurrentAccountInfo());this.connect=async()=>(console.log("\u{1F680} ~ MSafeWallet ~ AptosConnectMethod:"),this.getCurrentAccountInfo().then(e=>({status:_walletstandard.UserResponseStatus.APPROVED,args:e})));this.network=async()=>({name:this.config.network,chainId:this.config.network===_tssdk.Network.MAINNET?1:2});this.disconnect=async()=>(console.log("\u{1F680} ~ MSafeWallet ~ disconnect:"),Promise.resolve());this.signMessage=async e=>(console.log("\u{1F680} ~ MSafeWallet ~ signMessage:"),this.bellhop.send("signMessage",e),this.fetch("signMessageResponse"));this.signTransaction=async(e,n)=>(console.log("\u{1F680} ~ MSafeWallet ~ signTransaction:"),this.bellhop.send("signTransaction",{transaction:e,asFeePayer:n}),this.fetch("signTransactionResponse"));this.onAccountChange=async e=>{console.log("\u{1F680} ~ MSafeWallet ~ onAccountChange ~ listener:",e),this.onAccountChangeInput=e};this.onNetworkChange=async e=>{console.log("\u{1F680} ~ MSafeWallet ~ onNetworkChange ~ listener:",e),this.onNetworkChangeInput=e};let{network:n,appId:t,appUrl:i}=this.config,s="https://aptos-testnet.m-safe.io/";n!==_tssdk.Network.TESTNET&&(s="https://aptos.m-safe.io/"),t?this.url=`${s}/store/${t}`:this.url=`${s}/store/0?url=${i}`,this.bellhop.connect(),this.bellhop.on("changeAccount",async o=>{if(console.log("\u{1F680} ~ MSafeWallet ~ on ~ changeAccount:",o,this.onAccountChangeInput),this.onAccountChangeInput){let h=o.data.address;this.onAccountChangeInput(new (0, _walletstandard.AccountInfo)({address:_tssdk.AccountAddress.fromString(h),publicKey:new (0, _tssdk.Ed25519PublicKey)(h)}))}})}get features(){return{"aptos:connect":{version:"1.0.0",connect:this.connect},"aptos:network":{version:"1.0.0",network:this.network},"aptos:disconnect":{version:"1.0.0",disconnect:this.disconnect},"aptos:signTransaction":{version:"1.0.0",signTransaction:this.signTransaction},"aptos:signAndSubmitTransaction":{version:"1.0.0",signAndSubmitTransaction:this.signAndSubmitTransaction},"aptos:signMessage":{version:"1.0.0",signMessage:this.signMessage},"aptos:onAccountChange":{version:"1.0.0",onAccountChange:this.onAccountChange},"aptos:onNetworkChange":{version:"1.0.0",onNetworkChange:this.onNetworkChange},"aptos:account":{version:"1.0.0",account:this.account}}}async submitTransaction(e){return console.log("\u{1F680} ~ MSafeWallet ~ submitTransaction:"),this.bellhop.send("submitTransaction",{transaction:e}),this.fetch("submitTransactionResponse")}async signAndSubmitTransaction(e,n){if(console.log("\u{1F680} ~ MSafeWallet ~ signAndSubmitTransaction:",e),e.rawTransaction){let i=e,s=new _tssdk.Serializer;i.rawTransaction.serialize(s);let o=_tssdk.Hex.fromHexInput(s.toUint8Array()).toString();this.bellhop.send("signAndSubmitTransaction",{transaction:e,options:n,content:o})}else this.bellhop.send("signAndSubmitTransaction",{transaction:e,options:n});return await this.fetch("signAndSubmitTransactionResponse")}async getCurrentAccountInfo(){this.bellhop.send("connect");let{address:e}=await this.fetch("connectResponse");return console.log("\u{1F680} ~ MSafeWallet ~ getCurrentAccountInfo ~ address:",e),new (0, _walletstandard.AccountInfo)({address:_tssdk.AccountAddress.fromString(e),publicKey:new (0, _tssdk.Ed25519PublicKey)(e)})}async fetch(e){return new Promise(n=>{this.bellhop.fetch(e,t=>{n(t.data)})})}};exports.MSafeWallet = m; exports.MSafeWalletAccount = f; exports.MSafeWalletName = A; exports.MSafeWalletServer = S; exports.inMSafeWallet = ie;
//# sourceMappingURL=index.js.map